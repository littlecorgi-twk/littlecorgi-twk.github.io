<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Androidæºç ä¹‹SharedPreferences | å°æŸ¯åŸº</title><meta name="author" content="littlecorgi"><meta name="copyright" content="littlecorgi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="SharedPreferencesæºç åˆ†æ0. å‰è¨€SharedPreferenceså¯ä»¥è¯´æ˜¯Androidä¸­æœ€å¸¸ç”¨çš„ä¸€ç§å­˜æ•°æ®åˆ°æ–‡ä»¶çš„æ–¹å¼ã€‚ä»–çš„æ•°æ®æ˜¯ä»¥é”®å€¼å¯¹çš„æ–¹å¼å­˜å‚¨åœ¨ ~&amp;#x2F;data&amp;#x2F;data&amp;#x2F;åŒ…å&amp;#x2F;shared_prefs è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­çš„ã€‚ è¿™ä¸ªå­˜å‚¨æ¡†æ¶æ˜¯éå¸¸è½»é‡çº§çš„ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å­˜ä¸€äº›å°æ•°æ®"><link rel="shortcut icon" href="https://i.loli.net/2017/11/26/5a19c0b50432e.png"><link rel="canonical" href="https://www.littlecorgi.top/posts/24e17cf4"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d96f5834c289ac641e8340af58c61f69";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç®€"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: 
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Androidæºç ä¹‹SharedPreferences',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-07-05 22:09:27'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="å°æŸ¯åŸº" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/uploads/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">65</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">43</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">9</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡å¿—</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> æ–‡æ¡£</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Koin"><i class="fa-fw /koin/"></i><span> 0</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://dignitas.digital/wp-content/uploads/2019/02/SharedAndroid2-e1550504097495.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">å°æŸ¯åŸº</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡å¿—</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> æ–‡æ¡£</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Koin"><i class="fa-fw /koin/"></i><span> 0</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Androidæºç ä¹‹SharedPreferences</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2020-07-05T14:09:27.000Z" title="å‘è¡¨äº 2020-07-05 22:09:27">2020-07-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2020-07-05T14:09:27.000Z" title="æ›´æ–°äº 2020-07-05 22:09:27">2020-07-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android/">Android</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Androidæºç ä¹‹SharedPreferences"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="SharedPreferencesæºç åˆ†æ"><a href="#SharedPreferencesæºç åˆ†æ" class="headerlink" title="SharedPreferencesæºç åˆ†æ"></a>SharedPreferencesæºç åˆ†æ</h1><h1 id="0-å‰è¨€"><a href="#0-å‰è¨€" class="headerlink" title="0. å‰è¨€"></a>0. å‰è¨€</h1><p>SharedPreferenceså¯ä»¥è¯´æ˜¯Androidä¸­æœ€å¸¸ç”¨çš„ä¸€ç§å­˜æ•°æ®åˆ°æ–‡ä»¶çš„æ–¹å¼ã€‚ä»–çš„æ•°æ®æ˜¯ä»¥é”®å€¼å¯¹çš„æ–¹å¼å­˜å‚¨åœ¨ <code>~/data/data/åŒ…å/shared_prefs</code> è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­çš„ã€‚</p>
<p>è¿™ä¸ªå­˜å‚¨æ¡†æ¶æ˜¯éå¸¸è½»é‡çº§çš„ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å­˜ä¸€äº›å°æ•°æ®æˆ–è€…æ˜¯ä¸€ä¸ªå°å‹çš„å¯åºåˆ—åŒ–çš„Beanå®ä½“ç±»çš„ï¼Œä½¿ç”¨SharedPreferencesæ˜¯æœ€æ˜æ™ºçš„é€‰æ‹©ã€‚</p>
<span id="more"></span>
<h1 id="1-ä½¿ç”¨æ–¹æ³•"><a href="#1-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="1. ä½¿ç”¨æ–¹æ³•"></a>1. ä½¿ç”¨æ–¹æ³•</h1><h2 id="1-1-è·å–SharedPreferences"><a href="#1-1-è·å–SharedPreferences" class="headerlink" title="1.1 è·å–SharedPreferences"></a>1.1 è·å–SharedPreferences</h2><p>åœ¨ä½¿ç”¨SharedPreferenceså‰ï¼Œæˆ‘ä»¬å¾—å…ˆè·å–åˆ°å®ƒã€‚</p>
<p>ç”±äºSharedPreferencesæ˜¯Androidå†…ç½®çš„ä¸€ä¸ªæ¡†æ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬æƒ³è¦è·å–åˆ°å®ƒéå¸¸çš„ç®€å•ï¼Œä¸éœ€è¦å¯¼å…¥ä»»ä½•ä¾èµ–ï¼Œç›´æ¥å†™ä»£ç å°±è¡Œã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥ä»‹ç»ä¸‹è·å–å¯¹è±¡çš„ä¸‰ä¸ªæ–¹å¼ï¼š</p>
<h3 id="1-1-1-Context-getSharedPreferences"><a href="#1-1-1-Context-getSharedPreferences" class="headerlink" title="1.1.1 Context # getSharedPreferences()"></a>1.1.1 Context # getSharedPreferences()</h3><p>é¦–å…ˆå°±æ˜¯å¯ä»¥è¯´æ˜¯æœ€å¸¸ç”¨çš„æ–¹æ³•ï¼Œé€šè¿‡Contextçš„<code>getSharedPreferences()</code> æ–¹æ³•å»è·å–åˆ°SharedPreferenceså¯¹è±¡ã€‚ç”±äºæ˜¯é€šè¿‡Contextè·å–çš„ï¼Œæ‰€ä»¥åŸºæœ¬ä¸ŠAndroidçš„æ‰€æœ‰åœºæ™¯æˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•è·å–åˆ°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> SharedPreferences <span class="title function_">getSharedPreferences</span> <span class="params">(String name, </span></span><br><span class="line"><span class="params">                <span class="type">int</span> mode)</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯<code>name</code>å’Œ<code>mode</code>ï¼š</p>
<ul>
<li><code>name</code>ï¼šnameå°±æ˜¯æˆ‘ä»¬è¦å­˜å‚¨çš„SharedPreferencesæœ¬åœ°æ–‡ä»¶çš„åå­—ï¼Œè¿™ä¸ªå¯ä»¥è‡ªå®šä¹‰ã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨åŒæ ·çš„nameçš„è¯ï¼Œæ°¸è¿œåªèƒ½è·å–åˆ°åŒä¸€ä¸ªSharedPreferencesçš„å¯¹è±¡ã€‚</li>
<li><code>mode</code>ï¼šmodeå°±æ˜¯æˆ‘ä»¬è¦è·å–çš„è¿™ä¸ªSharedPreferencesçš„è®¿é—®æ¨¡å¼ï¼ŒAndroidç»™æˆ‘ä»¬æä¾›äº†æŒºå¤šçš„æ¨¡å¼çš„ï¼Œä½†æ˜¯ç”±äºå…¶ä½™çš„æ¨¡å¼æˆ–å¤šæˆ–å°‘å­˜åœ¨ç€å®‰å…¨éšæ‚£(å› ä¸ºå…¶ä»–åº”ç”¨ä¹Ÿå¯ä»¥ç›´æ¥è·å–åˆ°)ï¼Œæ‰€ä»¥å°±å…¨éƒ¨éƒ½å¼ƒç”¨äº†ï¼Œç°åœ¨å°±åªæœ‰ä¸€ä¸ª<code>MODE_PRIVATE</code>æ¨¡å¼ã€‚</li>
</ul>
<p>æ­¤å¤–ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p><code>Mode</code>çš„å¯é€‰å‚æ•°ï¼š</p>
<ul>
<li><code>MODE_PRIVATE</code>ï¼šç§æœ‰æ¨¡å¼ï¼Œè¯¥SharedPreferencesåªä¼šè¢«è°ƒç”¨ä»–çš„APPå»ä½¿ç”¨ï¼Œå…¶ä»–çš„APPæ— æ³•è·å–åˆ°è¿™ä¸ªSharedPreferencesã€‚</li>
<li><del><code>MODE_WORLD_READABLE</code></del>ï¼šAPI17è¢«å¼ƒç”¨ã€‚ä½¿ç”¨è¿™ä¸ªæ¨¡å¼ï¼Œæ‰€æœ‰çš„APPéƒ½å¯ä»¥å¯¹è¿™ä¸ªSharedPreferencesè¿›è¡Œè¯»æ“ä½œã€‚æ‰€ä»¥è¿™ä¸ªæ¨¡å¼è¢«Androidå®˜æ–¹ä¸¥å‰è­¦å‘Šç¦æ­¢ä½¿ç”¨ï¼ˆIt is strongly discouragedï¼‰ï¼Œå¹¶æ¨èä½¿ç”¨<code>ContentProvider</code>ã€<code>BroadcastReceiver</code>å’Œ<code>Service</code>ã€‚</li>
<li><del><code>MODE_WORLD_WRITEABLE</code></del>ï¼šAPI17è¢«å¼ƒç”¨ã€‚å’Œä¸Šé¢ç±»ä¼¼ï¼Œè¿™ä¸ªæ˜¯å¯ä»¥è¢«æ‰€æœ‰APPè¿›è¡Œå†™æ“ä½œã€‚åŒæ ·ä¹Ÿæ˜¯è¢«ä¸¥å‰è­¦å‘Šç¦æ­¢ä½¿ç”¨ã€‚</li>
<li><del><code>MODE_MULTI_PROCESS</code></del>ï¼šAPI23è¢«å¼ƒç”¨ã€‚ä½¿ç”¨äº†è¿™ä¸ªæ¨¡å¼ï¼Œå…è®¸å¤šä¸ªè¿›ç¨‹å¯¹åŒä¸€ä¸ªSharedPreferencesè¿›è¡Œæ“ä½œï¼Œä½†æ˜¯åæ¥ä¹Ÿè¢«å¯ç”¨äº†ï¼ŒåŸå› æ˜¯å› ä¸ºåœ¨æŸäº›Androidç‰ˆæœ¬ä¸‹ï¼Œè¿™ä¸ªæ¨¡å¼ä¸èƒ½å¯é çš„è¿è¡Œï¼Œå®˜æ–¹å»ºè®®å¦‚æœå¤šè¿›ç¨‹å»ºè®®ä½¿ç”¨<code>ContentProvider</code>å»æ“ä½œã€‚åœ¨åé¢æˆ‘ä»¬ä¼šè¯´ä¸ºå•¥å¤šè¿›ç¨‹ä¸‹ä¸å¯é ã€‚</li>
</ul>
<h3 id="1-1-2-Activity-getPreferences"><a href="#1-1-2-Activity-getPreferences" class="headerlink" title="1.1.2 Activity # getPreferences()"></a>1.1.2 Activity # getPreferences()</h3><p>è¿™ä¸ªæ–¹æ³•åªèƒ½åœ¨Activityä¸­æˆ–è€…é€šè¿‡Activityå¯¹è±¡å»ä½¿ç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SharedPreferences <span class="title function_">getPreferences</span> <span class="params">(<span class="type">int</span> mode)</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ª<code>mode</code>å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°å’Œä¸Šé¢çš„<code>context#getSharedPreferences()</code>çš„<code>mode</code>å‚æ•°æ˜¯ä¸€æ ·çš„ã€‚å…¶å®è¿™ä¸ªæ–¹æ³•å’Œä¸Šé¢Contextçš„é‚£ä¸ªæ–¹æ³•æ˜¯ä¸€æ ·çš„ï¼Œä»–ä¸¤éƒ½æ˜¯è°ƒç”¨çš„<code>SharedPreferences getSharedPreferences(String name, int mode)</code>ã€‚åªä¸è¿‡Contextçš„éœ€è¦ä½ å»æŒ‡å®šæ–‡ä»¶åï¼Œè€Œè¿™ä¸ªæ–¹æ³•ä½ ä¸éœ€è¦æ‰‹åŠ¨å»æŒ‡å®šï¼Œè€Œæ˜¯ä¼šè‡ªåŠ¨å°†å½“å‰Activityçš„ç±»åä½œä¸ºäº†æ–‡ä»¶åã€‚</p>
<h3 id="1-1-3-PreferencesManager-getDefaultSharedPreferences"><a href="#1-1-3-PreferencesManager-getDefaultSharedPreferences" class="headerlink" title="1.1.3 PreferencesManager # getDefaultSharedPreferences()"></a>1.1.3 PreferencesManager # getDefaultSharedPreferences()</h3><p>è¿™ä¸ªä¸€èˆ¬ç”¨åœ¨Androidçš„è®¾ç½®é¡µé¢ä¸Šï¼Œæˆ–è€…è¯´ï¼Œæˆ‘ä»¬ä¹Ÿåªæœ‰åœ¨æ„å»ºè®¾ç½®é¡µé¢çš„æ—¶å€™æ‰ä¼šå»ä½¿ç”¨è¿™ä¸ªã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SharedPreferences <span class="title function_">getDefaultSharedPreferences</span> <span class="params">(Context context)</span></span><br></pre></td></tr></table></figure>
<p>ä»–æ‰¿æ¥ä¸€ä¸ªcontextå‚æ•°ï¼Œå¹¶è‡ªåŠ¨å°†å½“å‰åº”ç”¨çš„æŠ¥åä½œä¸ºå‰ç¼€æ¥å‘½åæ–‡ä»¶ã€‚</p>
<h2 id="1-2-å­˜æ•°æ®"><a href="#1-2-å­˜æ•°æ®" class="headerlink" title="1.2 å­˜æ•°æ®"></a>1.2 å­˜æ•°æ®</h2><p>å¦‚æœéœ€è¦å¾€SharedPreferencesä¸­å­˜å‚¨æ•°æ®çš„è¯ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ç›´æ¥å¯¹SharedPreferenceså¯¹è±¡è¿›è¡Œæ“ä½œï¼Œå› ä¸ºSharedPreferencesæ²¡æœ‰æä¾›å­˜å‚¨æˆ–è€…ä¿®æ”¹æ•°æ®çš„æ¥å£ã€‚</p>
<p>å¦‚æœæƒ³è¦å¯¹SharedPreferenceså­˜å‚¨çš„æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œéœ€è¦é€šè¿‡<code>SharedPreferences.edit()</code>æ–¹æ³•å»è·å–åˆ°SharedPreferences.Editorå¯¹è±¡æ¥è¿›è¡Œæ“ä½œã€‚</p>
<p>è·å–åˆ°Editorå¯¹è±¡åï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ä»–çš„<code>putXXX()</code>æ–¹æ³•è¿›è¡Œå­˜å‚¨äº†ï¼Œå­˜å‚¨ä¹‹åä¸€å®šè®°å¾—é€šè¿‡<code>apply()</code>å’Œ<code>commit()</code>æ–¹æ³•å»å°†æ•°æ®æäº¤ã€‚</p>
<p>è‡³äº<code>commit</code>å’Œ<code>apply</code>çš„åŒºåˆ«æˆ‘ä»¬åé¢ä¼šè¯´ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//æ­¥éª¤1ï¼šåˆ›å»ºä¸€ä¸ªSharedPreferenceså¯¹è±¡</span></span><br><span class="line"> SharedPreferences sharedPreferences= getSharedPreferences(<span class="string">&quot;data&quot;</span>,Context.MODE_PRIVATE);</span><br><span class="line"> <span class="comment">//æ­¥éª¤2ï¼š å®ä¾‹åŒ–SharedPreferences.Editorå¯¹è±¡</span></span><br><span class="line"> SharedPreferences.<span class="type">Editor</span> <span class="variable">editor</span> <span class="operator">=</span> sharedPreferences.edit();</span><br><span class="line"> <span class="comment">//æ­¥éª¤3ï¼šå°†è·å–è¿‡æ¥çš„å€¼æ”¾å…¥æ–‡ä»¶</span></span><br><span class="line"> editor.putString(<span class="string">&quot;name&quot;</span>, â€œTomâ€);</span><br><span class="line"> editor.putInt(<span class="string">&quot;age&quot;</span>, <span class="number">28</span>);</span><br><span class="line"> editor.putBoolean(<span class="string">&quot;marrid&quot;</span>,<span class="literal">false</span>);</span><br><span class="line"> <span class="comment">//æ­¥éª¤4ï¼šæäº¤               </span></span><br><span class="line"> editor.commit();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// åˆ é™¤æŒ‡å®šæ•°æ®</span></span><br><span class="line"> editor.remove(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"> editor.commit();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// æ¸…ç©ºæ•°æ®</span></span><br><span class="line"> editor.clear();</span><br><span class="line"> editor.commit();</span><br></pre></td></tr></table></figure>
<h2 id="1-3-å–æ•°æ®"><a href="#1-3-å–æ•°æ®" class="headerlink" title="1.3 å–æ•°æ®"></a>1.3 å–æ•°æ®</h2><p>å–å€¼å°±å¾ˆç®€å•äº†ï¼Œæ„å»ºå‡ºSharedPreferencesçš„å¯¹è±¡åï¼Œå°±ç›´æ¥è°ƒç”¨SharedPreferencesçš„<code>getXXX()</code>æ–¹æ³•å°±è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SharedPreferences</span> <span class="variable">sharedPreferences</span> <span class="operator">=</span> getSharedPreferences(<span class="string">&quot;data&quot;</span>, Context .MODE_PRIVATE);</span><br><span class="line"><span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> sharedPreferences.getString(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>
<h1 id="2-æºç åˆ†æ"><a href="#2-æºç åˆ†æ" class="headerlink" title="2. æºç åˆ†æ"></a>2. æºç åˆ†æ</h1><h2 id="2-1-è·å–SharedPreferenceså®ä¾‹"><a href="#2-1-è·å–SharedPreferenceså®ä¾‹" class="headerlink" title="2.1 è·å–SharedPreferenceså®ä¾‹"></a>2.1 è·å–SharedPreferenceså®ä¾‹</h2><p>æˆ‘ä»¬ä¸Šé¢è¯´åˆ°ï¼Œè·å–SharedPreferenceså®ä¾‹æœ€å¸¸ç”¨çš„æ–¹æ³•å°±æ˜¯<code>Context#getSharedPreferences()</code>ã€‚é‚£æˆ‘ä»¬å°±ä»è¿™ä¸ªæ–¹æ³•å…¥æ‰‹ï¼Œçœ‹åˆ°åº•æ˜¯æ€ä¹ˆè·å–åˆ°SharedPreferenceså®ä¾‹çš„ã€‚</p>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContextWrapper</span> <span class="keyword">extends</span> <span class="title class_">Context</span> &#123;</span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    Context mBase;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SharedPreferences <span class="title function_">getSharedPreferences</span><span class="params">(String name, <span class="type">int</span> mode)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mBase.getSharedPreferences(name, mode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>å¯ä»¥çœ‹åˆ°ä»–åˆè°ƒç”¨äº†Contextçš„<code>getSharedPreferences()</code>æ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> SharedPreferences <span class="title function_">getSharedPreferences</span><span class="params">(String name, <span class="meta">@PreferencesMode</span> <span class="type">int</span> mode)</span>;</span><br></pre></td></tr></table></figure></p>
<p>ç„¶åæˆ‘ä»¬å°±ä¼šæƒŠå–œçš„å‘ç°ï¼Œè¿™æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ã€‚æˆ‘å¼€å§‹è¿˜æƒ³å»æ‰¾ä¸€ä¸ª<code>ContextWrapper</code>çš„æ„é€ çš„åœ°æ–¹ï¼Œçœ‹çœ‹<code>mBase</code>ä¼ å…¥çš„æ˜¯å•¥ï¼Œåæ¥æ‰¾äº†ä¸€åœˆæ²¡æ‰¾åˆ°ï¼Œç›´æ¥ä¸Šç½‘æœç´¢ï¼Œç«‹é©¬å¾—åˆ°ç­”æ¡ˆï¼š<code>ContextImpl</code>ï¼Œè¿™ä¸ªå¯ä»¥è¯´æ˜¯<code>Context</code>åœ¨Androidä¸­çš„å”¯ä¸€å®ç°ç±»ï¼Œæ‰€æœ‰çš„æ“ä½œåˆå¾—ç»è¿‡è¿™ä¸ªç±»ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±æ¥çœ‹ä¸‹è¿™ä¸ªç±»ä¸­çš„<code>getSharedPreferences()</code>æ–¹æ³•çš„å®ç°ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SharedPreferences <span class="title function_">getSharedPreferences</span><span class="params">(String name, <span class="type">int</span> mode)</span> &#123;</span><br><span class="line">    <span class="comment">// At least one application in the world actually passes in a null</span></span><br><span class="line">    <span class="comment">// name.  This happened to work because when we generated the file name</span></span><br><span class="line">    <span class="comment">// we would stringify it to &quot;null.xml&quot;.  Nice. </span></span><br><span class="line">            <span class="comment">// ps:è¿™ä¸ªniceå¾ˆç²¾é«“ğŸ˜‚</span></span><br><span class="line">    <span class="keyword">if</span> (mPackageInfo.getApplicationInfo().targetSdkVersion &lt;</span><br><span class="line">            Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">            name = <span class="string">&quot;null&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    File file;</span><br><span class="line">    <span class="comment">// åŠ äº†ä¸€ä¸ªç±»é”ï¼Œä¿è¯åŒæ­¥</span></span><br><span class="line">    <span class="keyword">synchronized</span> (ContextImpl.class) &#123;</span><br><span class="line">        <span class="comment">// mSharedPrefsPathsæ˜¯ä¸€ä¸ªä¿å­˜äº†nameå’Œfileå¯¹åº”å…³ç³»çš„ArrayMap</span></span><br><span class="line">        <span class="keyword">if</span> (mSharedPrefsPaths == <span class="literal">null</span>) &#123;</span><br><span class="line">            mSharedPrefsPaths = <span class="keyword">new</span> <span class="title class_">ArrayMap</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ ¹æ®nameä»é‡Œé¢æ‰¾æœ‰æ²¡æœ‰ç¼“å­˜çš„file</span></span><br><span class="line">        file = mSharedPrefsPaths.get(name);</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰ï¼Œé‚£å°±è°ƒç”¨getSharedPreferencesPathå»æ‰¾</span></span><br><span class="line">        <span class="keyword">if</span> (file == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// -&gt;&gt;&gt; é‡ç‚¹1. getSharedPreferencesPath(name)</span></span><br><span class="line">            file = getSharedPreferencesPath(name);</span><br><span class="line">            <span class="comment">// å¹¶ä¿å­˜åˆ°mSharedPrefsPaths</span></span><br><span class="line">            mSharedPrefsPaths.put(name, file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–åˆ°fileåï¼Œå†è°ƒç”¨getSharedPreferences</span></span><br><span class="line">    <span class="keyword">return</span> getSharedPreferences(file, mode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é‡ç‚¹1. ContextImpl # getSharedPreferencesPath(String name)</span></span><br><span class="line"><span class="comment"> *   æ ¹æ®PreferencesDirå’Œname.xmlå»åˆ›å»ºäº†è¿™ä¸ªæ–‡ä»¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> File <span class="title function_">getSharedPreferencesPath</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> makeFilename(getPreferencesDir(), name + <span class="string">&quot;.xml&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>é‚£æˆ‘ä»¬åœ¨çœ‹ä¸‹<code>getSharedPreferences(File file, int mode)</code>çš„å®ç°ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SharedPreferences <span class="title function_">getSharedPreferences</span><span class="params">(File file, <span class="type">int</span> mode)</span> &#123;</span><br><span class="line">    <span class="comment">// SharedPreferenceså”¯ä¸€å®ç°ç±»SharedPreferencesImplçš„å®ä¾‹</span></span><br><span class="line">    SharedPreferencesImpl sp;</span><br><span class="line">    <span class="comment">// åŒæ ·çš„åŠ ç±»é”</span></span><br><span class="line">    <span class="keyword">synchronized</span> (ContextImpl.class) &#123;</span><br><span class="line">        <span class="comment">// æ„é€ äº†ä¸€ä¸ªFile-SharedPreferencesImplå¯¹åº”å…³ç³»çš„ArrayMap</span></span><br><span class="line">        <span class="comment">// è°ƒç”¨getSharedPreferencesCacheLockedæ–¹æ³•åŒºè·å–cahce</span></span><br><span class="line">        <span class="comment">// -&gt;&gt;&gt; é‡ç‚¹1</span></span><br><span class="line">        <span class="keyword">final</span> ArrayMap&lt;File, SharedPreferencesImpl&gt; cache = getSharedPreferencesCacheLocked();</span><br><span class="line">        <span class="comment">// ä»file-SharedPreferencesImplé”®å€¼å¯¹ä¸­æ ¹æ®å½“å‰fileå»è¿‡å»SharedPreferencesImplå®ä¾‹</span></span><br><span class="line">        sp = cache.get(file);</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰ï¼Œé‚£å°±éœ€è¦æ–°å»ºä¸€ä¸ª</span></span><br><span class="line">        <span class="keyword">if</span> (sp == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ£€æŸ¥modeï¼Œå¦‚æœæ˜¯MODE_WORLD_WRITEABLEæˆ–è€…MODE_MULTI_PROCESSåˆ™ç›´æ¥æŠ›å¼‚å¸¸</span></span><br><span class="line">            checkMode(mode);</span><br><span class="line">            <span class="keyword">if</span> (getApplicationInfo().targetSdkVersion &gt;= android.os.Build.VERSION_CODES.O) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isCredentialProtectedStorage()</span><br><span class="line">                        &amp;&amp; !getSystemService(UserManager.class)</span><br><span class="line">                                .isUserUnlockingOrUnlocked(UserHandle.myUserId())) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;SharedPreferences in credential encrypted &quot;</span></span><br><span class="line">                            + <span class="string">&quot;storage are not available until after user is unlocked&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è°ƒç”¨æ„é€ æ–¹æ³•å»æ„é€ SharedPreferencesImplå¯¹è±¡</span></span><br><span class="line">            sp = <span class="keyword">new</span> <span class="title class_">SharedPreferencesImpl</span>(file, mode);</span><br><span class="line">            <span class="comment">// å°†å¯¹è±¡å’Œfileçš„é”®å€¼å¯¹å­˜å…¥cacheä¸­</span></span><br><span class="line">            cache.put(file, sp);</span><br><span class="line">            <span class="keyword">return</span> sp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((mode &amp; Context.MODE_MULTI_PROCESS) != <span class="number">0</span> ||</span><br><span class="line">        getApplicationInfo().targetSdkVersion &lt; android.os.Build.VERSION_CODES.HONEYCOMB) &#123;</span><br><span class="line">        <span class="comment">// If somebody else (some other process) changed the prefs</span></span><br><span class="line">        <span class="comment">// file behind our back, we reload it.  This has been the</span></span><br><span class="line">        <span class="comment">// historical (if undocumented) behavior.</span></span><br><span class="line">        sp.startReloadIfChangedUnexpectedly();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é‡ç‚¹1. ContextImap # getSharedPreferencesCacheLocked()</span></span><br><span class="line"><span class="comment"> *   æ ¹æ®å½“å‰çš„åŒ…åï¼Œå»è·å–åˆ°ç”±æ­¤åº”ç”¨åˆ›å»ºçš„File-SharedPreferencesImplçš„Mapå¯¹è±¡ï¼Œ</span></span><br><span class="line"><span class="comment"> *       è€Œè¿™ä¸ªå¯¹è±¡é‡Œé¢å°±å­˜æ”¾äº†è¿™ä¸ªåº”ç”¨åˆ›å»ºçš„æ‰€æœ‰çš„SharedPreferencesImplå’ŒFileçš„å¯¹åº”å…³ç³»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GuardedBy(&quot;ContextImpl.class&quot;)</span></span><br><span class="line"><span class="keyword">private</span> ArrayMap&lt;File, SharedPreferencesImpl&gt; <span class="title function_">getSharedPreferencesCacheLocked</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœsSharedPrefsCacheä¸ºç©ºå°±æ„é€ ä¸€ä¸ªArrayMap</span></span><br><span class="line">    <span class="comment">// sSharedPrefsCacheå°±æ˜¯ä¸€ä¸ªå­˜æ”¾String-String, ArrayMap&lt;File, SharedPreferencesImpl&gt;çš„Map</span></span><br><span class="line">    <span class="comment">// æ¢å¥è¯è¯´ï¼Œä¹Ÿå°±æ˜¯å­˜æ”¾åŒ…å-packagePrefså¯¹åº”å…³ç³»çš„Map</span></span><br><span class="line">    <span class="keyword">if</span> (sSharedPrefsCache == <span class="literal">null</span>) &#123;</span><br><span class="line">        sSharedPrefsCache = <span class="keyword">new</span> <span class="title class_">ArrayMap</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–åŒ…å</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> getPackageName();</span><br><span class="line">    <span class="comment">// åˆ°sSharedPrefsCacheä¸­æ‰¾</span></span><br><span class="line">    ArrayMap&lt;File, SharedPreferencesImpl&gt; packagePrefs = sSharedPrefsCache.get(packageName);</span><br><span class="line">    <span class="comment">// å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±æ„å»ºä¸€ä¸ªç„¶åå­˜è¿›å»</span></span><br><span class="line">    <span class="keyword">if</span> (packagePrefs == <span class="literal">null</span>) &#123;</span><br><span class="line">        packagePrefs = <span class="keyword">new</span> <span class="title class_">ArrayMap</span>&lt;&gt;();</span><br><span class="line">        sSharedPrefsCache.put(packageName, packagePrefs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰¾å¾—åˆ°å°±è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> packagePrefs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-2-æ„å»ºSharedPreferencesImpl"><a href="#2-2-æ„å»ºSharedPreferencesImpl" class="headerlink" title="2.2 æ„å»ºSharedPreferencesImpl"></a>2.2 æ„å»ºSharedPreferencesImpl</h2><h3 id="2-2-1-SharedPreferencesImplæ„é€ æ–¹æ³•"><a href="#2-2-1-SharedPreferencesImplæ„é€ æ–¹æ³•" class="headerlink" title="2.2.1 SharedPreferencesImplæ„é€ æ–¹æ³•"></a>2.2.1 SharedPreferencesImplæ„é€ æ–¹æ³•</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">SharedPreferencesImpl(File file, <span class="type">int</span> mode) &#123;</span><br><span class="line">    mFile = file;</span><br><span class="line">    <span class="comment">// fileçš„å¤‡ä»½æ–‡ä»¶</span></span><br><span class="line">    mBackupFile = makeBackupFile(file);</span><br><span class="line">    mMode = mode;</span><br><span class="line">    <span class="comment">// ä»ç£ç›˜åŠ è½½çš„æ ‡å¿—ï¼Œå½“éœ€è¦ä»ç£ç›˜åŠ è½½æ—¶å°†å…¶è®¾ä¸ºtrueï¼Œè¿™æ ·å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹ä¹Ÿè°ƒç”¨äº†SharedPreferencesçš„åŠ è½½æ–¹æ³•æ—¶ï¼Œå°±ä¼šå› ä¸ºå…¶ä¸ºtrueè€Œç›´æ¥è¿”å›ä¹Ÿå°±ä¸æ‰§è¡ŒåŠ è½½æ–¹æ³•</span></span><br><span class="line">    <span class="comment">// ä¿è¯äº†å…¨å±€åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨åŠ è½½</span></span><br><span class="line">    mLoaded = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// SharedPreferencesä¸­çš„æ•°æ®</span></span><br><span class="line">    mMap = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// ä¿å­˜çš„é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">    mThrowable = <span class="literal">null</span>;</span><br><span class="line">    startLoadFromDisk();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åˆå§‹åŒ–å‚æ•°åç«‹é©¬è°ƒç”¨äº†<code>startLoadFromDisk()</code>æ–¹æ³•ï¼š</p>
<h3 id="2-2-2-startLoadFromDisk"><a href="#2-2-2-startLoadFromDisk" class="headerlink" title="2.2.2 startLoadFromDisk()"></a>2.2.2 startLoadFromDisk()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startLoadFromDisk</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        mLoaded = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¼€å¯ä¸€ä¸ªæ–°çº¿ç¨‹æ¥åŠ è½½æ•°æ®</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;SharedPreferencesImpl-load&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            loadFromDisk();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-3-loadFromDIsk"><a href="#2-2-3-loadFromDIsk" class="headerlink" title="2.2.3 loadFromDIsk()"></a>2.2.3 loadFromDIsk()</h3><p><code>loadFromDisk()</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadFromDisk</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå·²ç»å®¶åœ¨è¿‡äº†ï¼Œå°±ç›´æ¥é€€å‡º</span></span><br><span class="line">        <span class="keyword">if</span> (mLoaded) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœå¤‡ä»½æ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œé‚£å°±åˆ é™¤æºæ–‡ä»¶ï¼Œå¹¶å°†å¤‡ä»½æ–‡ä»¶æ›¿æ¢ä¸ºæºæ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (mBackupFile.exists()) &#123;</span><br><span class="line">            mFile.delete();</span><br><span class="line">            mBackupFile.renameTo(mFile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Debugging</span></span><br><span class="line">    <span class="keyword">if</span> (mFile.exists() &amp;&amp; !mFile.canRead()) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">&quot;Attempt to read preferences file &quot;</span> + mFile + <span class="string">&quot; without permission&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­˜å‚¨èšçš„map</span></span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// æ–‡ä»¶ä¿¡æ¯ï¼Œå¯¹åº”çš„æ˜¯Cè¯­è¨€stat.hä¸­çš„struct stat</span></span><br><span class="line">    <span class="type">StructStat</span> <span class="variable">stat</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Throwable</span> <span class="variable">thrown</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡æ–‡ä»¶è·¯å¾„å»æ„å»ºStructStatå¯¹è±¡</span></span><br><span class="line">        stat = Os.stat(mFile.getPath());</span><br><span class="line">        <span class="keyword">if</span> (mFile.canRead()) &#123;</span><br><span class="line">            <span class="comment">// ä»XMLä¸­æŠŠæ•°æ®è¯»å‡ºæ¥ï¼Œå¹¶æŠŠæ•°æ®è½¬åŒ–æˆMapç±»å‹</span></span><br><span class="line">            <span class="type">BufferedInputStream</span> <span class="variable">str</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                str = <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(mFile), <span class="number">16</span> * <span class="number">1024</span>);</span><br><span class="line">                map = (Map&lt;String, Object&gt;) XmlUtils.readMapXml(str);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">&quot;Cannot read &quot;</span> + mFile.getAbsolutePath(), e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                IoUtils.closeQuietly(str);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ErrnoException e) &#123;</span><br><span class="line">        <span class="comment">// An errno exception means the stat failed. Treat as empty/non-existing by</span></span><br><span class="line">        <span class="comment">// ignoring.</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        thrown = t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        mLoaded = <span class="literal">true</span>;</span><br><span class="line">        mThrowable = thrown;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// It&#x27;s important that we always signal waiters, even if we&#x27;ll make</span></span><br><span class="line">        <span class="comment">// them fail with an exception. The try-finally is pretty wide, but</span></span><br><span class="line">        <span class="comment">// better safe than sorry.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (thrown == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// æ–‡ä»¶é‡Œæ‹¿åˆ°çš„æ•°æ®ä¸ºç©ºå°±é‡å»ºï¼Œå­˜åœ¨å°±èµ‹å€¼</span></span><br><span class="line">                <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// å°†æ•°æ®å­˜å‚¨æ”¾ç½®åˆ°å…·ä½“ç±»çš„ä¸€ä¸ªå…¨å±€å˜é‡ä¸­</span></span><br><span class="line">                    <span class="comment">// ç¨å¾®è®°ä¸€ä¸‹è¿™ä¸ªå…³é”®ç‚¹</span></span><br><span class="line">                    mMap = map;</span><br><span class="line">                    mStatTimestamp = stat.st_mtim;</span><br><span class="line">                    mStatSize = stat.st_size;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// In case of a thrown exception, we retain the old map. That allows</span></span><br><span class="line">            <span class="comment">// any open editors to commit and store updates.</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            mThrowable = t;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mLock.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>åˆ°ç›®å‰æ¥è¯´ï¼Œå°±å®Œæˆçš„SharedPreferencesImplçš„æ„å»ºè¿‡ç¨‹ã€‚</p>
<h2 id="2-3-è¯»æ•°æ®-SharedPreferences-getXXX"><a href="#2-3-è¯»æ•°æ®-SharedPreferences-getXXX" class="headerlink" title="2.3 è¯»æ•°æ® SharedPreferences # getXXX()"></a>2.3 è¯»æ•°æ® SharedPreferences # getXXX()</h2><p>ç›¸å¯¹æ¥è¯´ï¼Œè¯»æ•°æ®æ¶‰åŠåˆ°çš„æ–¹æ³•æ¯”å†™æ•°æ®ç®€å•å¾—å¤šï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹è¯»æ•°æ®ï¼š<br>æˆ‘ä»¬ä»¥<code>getString()</code>ä¸ºä¾‹</p>
<h3 id="2-3-1-getString"><a href="#2-3-1-getString" class="headerlink" title="2.3.1 getString"></a>2.3.1 getString</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getString</span><span class="params">(String key, <span class="meta">@Nullable</span> String defValue)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">// è§2.3.2</span></span><br><span class="line">        awaitLoadedLocked();</span><br><span class="line">        <span class="comment">// ä»mapä¸­è·å–æ•°æ®</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">v</span> <span class="operator">=</span> (String)mMap.get(key);</span><br><span class="line">        <span class="comment">// å¦‚æœè·å–åˆ°æ•°æ®ï¼Œå°±è¿”å›æ•°æ®ï¼Œå¦åˆ™è¿”å›æ–¹æ³•å‚æ•°ä¸­ç»™å®šçš„é»˜è®¤å€¼</span></span><br><span class="line">        <span class="keyword">return</span> v != <span class="literal">null</span> ? v : defValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-2-awaitLoadedLocked"><a href="#2-3-2-awaitLoadedLocked" class="headerlink" title="2.3.2 awaitLoadedLocked"></a>2.3.2 awaitLoadedLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GuardedBy(&quot;mLock&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">awaitLoadedLocked</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰åŠ è½½è¿‡ï¼Œåˆ™è¿›è¡ŒåŠ è½½</span></span><br><span class="line">    <span class="keyword">if</span> (!mLoaded) &#123;</span><br><span class="line">        <span class="comment">// Raise an explicit StrictMode onReadFromDisk for this</span></span><br><span class="line">        <span class="comment">// thread, since the real read will be in a different</span></span><br><span class="line">        <span class="comment">// thread and otherwise ignored by StrictMode.</span></span><br><span class="line">        BlockGuard.getThreadPolicy().onReadFromDisk();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰åŠ è½½è¿‡ï¼Œåˆ™ç­‰å¾…</span></span><br><span class="line">    <span class="keyword">while</span> (!mLoaded) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mLock.wait();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException unused) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mThrowable != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(mThrowable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•ç®€å•ç‚¹æ¥è¯´å°±æ˜¯å¦‚æœ<code>mLoad</code>ä¸ä¸ºtrueä¹Ÿå°±æ˜¯æ²¡æœ‰åŠ è½½å®Œæˆçš„è¯ï¼Œå°±ç­‰å¾…åŠ è½½å®Œæˆã€‚</p>
<h2 id="2-4-å†™æ•°æ®"><a href="#2-4-å†™æ•°æ®" class="headerlink" title="2.4 å†™æ•°æ®"></a>2.4 å†™æ•°æ®</h2><h3 id="2-4-1-SharedPreferences-Editor"><a href="#2-4-1-SharedPreferences-Editor" class="headerlink" title="2.4.1 SharedPreferences.Editor"></a>2.4.1 SharedPreferences.Editor</h3><p>ä½†æ˜¯å…‰æ„å»ºäº†å¯¹è±¡è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜å¾—èƒ½å¯¹å¥¹è¿›è¡Œæ“ä½œã€‚æˆ‘ä»¬å‰é¢è¯´åˆ°è¿‡ï¼ŒSharedPreferenceså¹¶ä¸æä¾›ä¿®æ”¹çš„åŠŸèƒ½ï¼Œå¦‚æœä½ æƒ³å¯¹å¥¹è¿›è¡Œä¿®æ”¹ï¼Œå¿…é¡»é€šè¿‡<code>SharedPreferences.Editor</code>æ¥å®ç°ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹<code>SharedPreferences.edit()</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Editor <span class="title function_">edit</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> remove the need to call awaitLoadedLocked() when</span></span><br><span class="line">    <span class="comment">// requesting an editor.  will require some work on the</span></span><br><span class="line">    <span class="comment">// Editor, but then we should be able to do:</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//      context.getSharedPreferences(..).edit().putString(..).apply()</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// ... all without blocking.</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">// -&gt;&gt;&gt; é‡ç‚¹1</span></span><br><span class="line">        awaitLoadedLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºäº†ä¸€ä¸ªEditorImplçš„å¯¹è±¡ï¼Œ</span></span><br><span class="line">    <span class="comment">// ä½†æ˜¯è¿™å—éœ€è¦æ³¨æ„ä¸‹ï¼Œæˆ‘ä»¬æƒ³å¯¹SharedPreferencesè¿›è¡Œä¿®æ”¹ï¼Œå°±å¿…é¡»è°ƒç”¨edit()æ–¹æ³•ï¼Œå°±ä¼šå»æ„å»ºä¸€ä¸ªæ–°çš„EditorImplå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥ä¸ºäº†é¿å…ä¸å¿…è¦çš„å¼€é”€ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨æ—¶æœ€å¥½ä¸€æ¬¡æ€§å®Œæˆå¯¹æ•°æ®çš„æ“ä½œ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EditorImpl</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é‡ç‚¹1ï¼šSharedPreferencesImpl # awaitLoadedLocked()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GuardedBy(&quot;mLock&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">awaitLoadedLocked</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mLoaded) &#123;</span><br><span class="line">        <span class="comment">// Raise an explicit StrictMode onReadFromDisk for this</span></span><br><span class="line">        <span class="comment">// thread, since the real read will be in a different</span></span><br><span class="line">        <span class="comment">// thread and otherwise ignored by StrictMode.</span></span><br><span class="line">        BlockGuard.getThreadPolicy().onReadFromDisk();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (!mLoaded) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœè¿˜æ²¡æœ‰åŠ è½½å®Œæˆï¼Œå°±è¿›å…¥ç­‰å¾…çŠ¶æ€</span></span><br><span class="line">            mLock.wait();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException unused) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mThrowable != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(mThrowable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-4-2-EditorImpl"><a href="#2-4-2-EditorImpl" class="headerlink" title="2.4.2 EditorImpl"></a>2.4.2 EditorImpl</h3><h4 id="2-4-2-1-putXXX"><a href="#2-4-2-1-putXXX" class="headerlink" title="2.4.2.1 putXXX()"></a>2.4.2.1 putXXX()</h4><p>é‚£æˆ‘ä»¬å†æ¥çœ‹ä¸‹<code>putXXX()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬ä»¥<code>putString()</code>æ¥ä¸¾ä¾‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">EditorImpl</span> <span class="keyword">implements</span> <span class="title class_">Editor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">mEditorLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­˜æ•°æ®çš„HashMap</span></span><br><span class="line">    <span class="meta">@GuardedBy(&quot;mEditorLock&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; mModified = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GuardedBy(&quot;mEditorLock&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">mClear</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Editor <span class="title function_">putString</span><span class="params">(String key, <span class="meta">@Nullable</span> String value)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mEditorLock) &#123;</span><br><span class="line">            mModified.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p><code>putString()</code>æ–¹æ³•å¾ˆç®€å•ï¼Œç›´æ¥å°†æ•°æ®putåˆ°å­˜æ•°æ®çš„HashMapä¸­å»å°±è¡Œäº†ã€‚æˆ–è€…è¯´ï¼Œæ‰€æœ‰çš„<code>putXXX()</code>éƒ½æ˜¯è¿™ä¹ˆç®€å•ã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å°†ä¿®æ”¹æäº¤åˆ°SharedPreferencesé‡Œé¢å»çš„è¯ï¼Œè¿˜éœ€è¦è°ƒç”¨<code>apply()</code>æˆ–è€…<code>commit()</code>æ–¹æ³•ï¼Œé‚£æˆ‘ä»¬ç°åœ¨æ¥çœ‹ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚</p>
<h4 id="2-4-2-2-apply"><a href="#2-4-2-2-apply" class="headerlink" title="2.4.2.2 apply()"></a>2.4.2.2 apply()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰æ—¶é—´</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§2.2.3.4</span></span><br><span class="line">    <span class="comment">// æ„å»ºäº†ä¸€ä¸ªMemoryCommitResultçš„å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">MemoryCommitResult</span> <span class="variable">mcr</span> <span class="operator">=</span> commitToMemory();</span><br><span class="line">    <span class="comment">// æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå› ä¸ºæ•°æ®æ“ä½œæ˜¯å¾ˆè€—æ—¶çš„</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">awaitCommit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// è¿›å…¥ç­‰å¾…çŠ¶æ€</span></span><br><span class="line">                    mcr.writtenToDiskLatch.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (DEBUG &amp;&amp; mcr.wasWritten) &#123;</span><br><span class="line">                    Log.d(TAG, mFile.getName() + <span class="string">&quot;:&quot;</span> + mcr.memoryStateGeneration</span><br><span class="line">                            + <span class="string">&quot; applied after &quot;</span> + (System.currentTimeMillis() - startTime)</span><br><span class="line">                            + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†awaitCommitæ·»åŠ åˆ°Queueçš„Wordä¸­å»</span></span><br><span class="line">    QueuedWork.addFinisher(awaitCommit);</span><br><span class="line"></span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">postWriteRunnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="comment">// æ‰§è¡Œæ“ä½œï¼Œå¹¶ä»QueuedWordä¸­åˆ é™¤</span></span><br><span class="line">                awaitCommit.run();</span><br><span class="line">                QueuedWork.removeFinisher(awaitCommit);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    SharedPreferencesImpl.<span class="built_in">this</span>.enqueueDiskWrite(mcr, postWriteRunnable);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Okay to notify the listeners before it&#x27;s hit disk</span></span><br><span class="line">    <span class="comment">// because the listeners should always get the same</span></span><br><span class="line">    <span class="comment">// SharedPreferences instance back, which has the</span></span><br><span class="line">    <span class="comment">// changes reflected in memory.</span></span><br><span class="line">    notifyListeners(mcr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-4-2-3-commit"><a href="#2-4-2-3-commit" class="headerlink" title="2.4.2.3 commit()"></a>2.4.2.3 commit()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">commit</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        startTime = System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§2.2.3.4</span></span><br><span class="line">    <span class="comment">// æ„å»ºäº†ä¸€ä¸ªMemoryCommitResultå¯¹è±¡</span></span><br><span class="line">    <span class="type">MemoryCommitResult</span> <span class="variable">mcr</span> <span class="operator">=</span> commitToMemory();</span><br><span class="line">    <span class="comment">// å°†å†…å­˜æ•°æ®åŒæ­¥åˆ°æ–‡ä»¶</span></span><br><span class="line">    <span class="comment">// è§</span></span><br><span class="line">    SharedPreferencesImpl.<span class="built_in">this</span>.enqueueDiskWrite(</span><br><span class="line">        mcr, <span class="literal">null</span> <span class="comment">/* sync write on this thread okay */</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è¿›å…¥ç­‰å¾…çŠ¶æ€, ç›´åˆ°å†™å…¥æ–‡ä»¶çš„æ“ä½œå®Œæˆ</span></span><br><span class="line">        mcr.writtenToDiskLatch.await();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Log.d(TAG, mFile.getName() + <span class="string">&quot;:&quot;</span> + mcr.memoryStateGeneration</span><br><span class="line">                    + <span class="string">&quot; committed after &quot;</span> + (System.currentTimeMillis() - startTime)</span><br><span class="line">                    + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€šçŸ¥ç›‘å¬åˆ™, å¹¶åœ¨ä¸»çº¿ç¨‹å›è°ƒonSharedPreferenceChanged()æ–¹æ³•</span></span><br><span class="line">    notifyListeners(mcr);</span><br><span class="line">    <span class="comment">// è¿”å›æ–‡ä»¶æ“ä½œçš„ç»“æœæ•°æ®</span></span><br><span class="line">    <span class="keyword">return</span> mcr.writeToDiskResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-4-2-4-commitToMemory"><a href="#2-4-2-4-commitToMemory" class="headerlink" title="2.4.2.4 commitToMemory()"></a>2.4.2.4 commitToMemory()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Returns true if any changes were made</span></span><br><span class="line"><span class="keyword">private</span> MemoryCommitResult <span class="title function_">commitToMemory</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å½“å‰Memoryçš„çŠ¶æ€ï¼Œå…¶å®ä¹Ÿå°±æ˜¯å½“éœ€è¦æäº¤æ•°æ®åˆ°å†…å­˜çš„æ—¶å€™ï¼Œä»–çš„å€¼å°±åŠ ä¸€</span></span><br><span class="line">    <span class="type">long</span> memoryStateGeneration;</span><br><span class="line">    List&lt;String&gt; keysModified = <span class="literal">null</span>;</span><br><span class="line">    Set&lt;OnSharedPreferenceChangeListener&gt; listeners = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// å­˜æ•°æ®çš„Map</span></span><br><span class="line">    Map&lt;String, Object&gt; mapToWriteToDisk;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (SharedPreferencesImpl.<span class="built_in">this</span>.mLock) &#123;</span><br><span class="line">        <span class="comment">// We optimistically don&#x27;t make a deep copy until</span></span><br><span class="line">        <span class="comment">// a memory commit comes in when we&#x27;re already</span></span><br><span class="line">        <span class="comment">// writing to disk.</span></span><br><span class="line">        <span class="comment">// å¦‚æœæœ‰æ•°æ®å¾…è¢«æäº¤åˆ°ç¡¬ç›˜</span></span><br><span class="line">        <span class="keyword">if</span> (mDiskWritesInFlight &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// We can&#x27;t modify our mMap as a currently</span></span><br><span class="line">            <span class="comment">// in-flight write owns it.  Clone it before</span></span><br><span class="line">            <span class="comment">// modifying it.</span></span><br><span class="line">            <span class="comment">// noinspection unchecked</span></span><br><span class="line">            mMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;(mMap);</span><br><span class="line">        &#125;</span><br><span class="line">        mapToWriteToDisk = mMap;</span><br><span class="line">        <span class="comment">// 2.2.3.5çš„å…³é”®ç‚¹</span></span><br><span class="line">        mDiskWritesInFlight++;</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasListeners</span> <span class="operator">=</span> mListeners.size() &gt; <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (hasListeners) &#123;</span><br><span class="line">            keysModified = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">            listeners = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;OnSharedPreferenceChangeListener&gt;(mListeners.keySet());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mEditorLock) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">changesMade</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å¦‚æœmClearä¸ºtrueï¼Œå°±æ¸…ç©ºmapToWriteToDisk</span></span><br><span class="line">            <span class="keyword">if</span> (mClear) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mapToWriteToDisk.isEmpty()) &#123;</span><br><span class="line">                    changesMade = <span class="literal">true</span>;</span><br><span class="line">                    mapToWriteToDisk.clear();</span><br><span class="line">                &#125;</span><br><span class="line">                mClear = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; e : mModified.entrySet()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">k</span> <span class="operator">=</span> e.getKey();</span><br><span class="line">                <span class="type">Object</span> <span class="variable">v</span> <span class="operator">=</span> e.getValue();</span><br><span class="line">                <span class="comment">// &quot;this&quot; is the magic value for a removal mutation. In addition,</span></span><br><span class="line">                <span class="comment">// setting a value to &quot;null&quot; for a given key is specified to be</span></span><br><span class="line">                <span class="comment">// equivalent to calling remove on that key.</span></span><br><span class="line">                <span class="keyword">if</span> (v == <span class="built_in">this</span> || v == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!mapToWriteToDisk.containsKey(k)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    mapToWriteToDisk.remove(k);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mapToWriteToDisk.containsKey(k)) &#123;</span><br><span class="line">                        <span class="type">Object</span> <span class="variable">existingValue</span> <span class="operator">=</span> mapToWriteToDisk.get(k);</span><br><span class="line">                        <span class="keyword">if</span> (existingValue != <span class="literal">null</span> &amp;&amp; existingValue.equals(v)) &#123;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    mapToWriteToDisk.put(k, v);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                changesMade = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (hasListeners) &#123;</span><br><span class="line">                    keysModified.add(k);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mModified.clear();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (changesMade) &#123;</span><br><span class="line">                mCurrentMemoryStateGeneration++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            memoryStateGeneration = mCurrentMemoryStateGeneration;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MemoryCommitResult</span>(memoryStateGeneration, keysModified, listeners,</span><br><span class="line">            mapToWriteToDisk);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç åˆšå¼€å§‹çœ‹çš„æ—¶å€™æœ‰ç‚¹æ™•ï¼Œä½†æ˜¯çœ‹å®Œåå°±ç¬é—´æ‡‚äº†ï¼Œè¿™æ®µä»£ç ä¸»è¦æ‰§è¡Œäº†ä¸€ä¸‹çš„åŠŸèƒ½ï¼š</p>
<ul>
<li>å°†<code>mMap</code>èµ‹å€¼ç»™<code>mapToWriteToDisk</code></li>
<li>å½“<code>mClear</code>ä¸ºtrueçš„æ—¶å€™ï¼Œæ¸…ç©º<code>mapToWriteToDisk</code></li>
<li>éå†<code>mModified</code>ï¼Œ<code>mModified</code>ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´åˆ°çš„ä¿å­˜æœ¬æ¬¡editçš„æ•°æ®çš„HashMap<ul>
<li>å½“å½“å‰çš„<code>value</code>ä¸ºnullæˆ–è€…<code>this</code>çš„æ—¶å€™ï¼Œç§»é™¤å¯¹åº”çš„k</li>
</ul>
</li>
<li>æ„å»ºäº†ä¸€ä¸ª<code>MemoryCommitResult</code>å¯¹è±¡</li>
</ul>
<h4 id="2-4-2-5-SharedPreferencesImpl-enqueueDiskWrite"><a href="#2-4-2-5-SharedPreferencesImpl-enqueueDiskWrite" class="headerlink" title="2.4.2.5 SharedPreferencesImpl # enqueueDiskWrite()"></a>2.4.2.5 SharedPreferencesImpl # enqueueDiskWrite()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enqueueDiskWrite</span><span class="params">(<span class="keyword">final</span> MemoryCommitResult mcr,</span></span><br><span class="line"><span class="params">                              <span class="keyword">final</span> Runnable postWriteRunnable)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isFromSyncCommit</span> <span class="operator">=</span> (postWriteRunnable == <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">writeToDiskRunnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (mWritingToDiskLock) &#123;</span><br><span class="line">                    <span class="comment">// è¿™ä¸ªæ–¹æ³•è¿™å—å°±ä¸è®²äº†ï¼Œå¤ªé•¿äº†ï¼Œå¤§å®¶æ„Ÿå…´è¶£å¯ä»¥çœ‹ä¸‹</span></span><br><span class="line">                    <span class="comment">// ä¸»è¦åŠŸèƒ½å°±æ˜¯</span></span><br><span class="line">                    <span class="comment">//  1. å½“æ²¡æœ‰keyæ²¡æœ‰æ”¹å˜ï¼Œåˆ™ç›´æ¥è¿”å›äº†ï¼›å¦åˆ™æ‰§è¡Œä¸‹ä¸€æ­¥</span></span><br><span class="line">                    <span class="comment">//  2. å°†mMapå…¨éƒ¨ä¿¡æ¯å†™å…¥æ–‡ä»¶ï¼Œå¦‚æœå†™å…¥æˆåŠŸåˆ™åˆ é™¤å¤‡ä»½æ–‡ä»¶ï¼Œå¦‚æœå†™å…¥å¤±è´¥åˆ™åˆ é™¤mFile</span></span><br><span class="line">                    writeToFile(mcr, isFromSyncCommit);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                    <span class="comment">// å½“å†™å…¥æˆåŠŸåï¼Œå°†æ ‡å¿—ä½å‡1</span></span><br><span class="line">                    mDiskWritesInFlight--;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ­¤æ—¶postWriteRunnableä¸ºnullä¸æ‰§è¡Œè¯¥æ–¹æ³•</span></span><br><span class="line">                <span class="keyword">if</span> (postWriteRunnable != <span class="literal">null</span>) &#123;</span><br><span class="line">                    postWriteRunnable.run();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Typical #commit() path with fewer allocations, doing a write on</span></span><br><span class="line">    <span class="comment">// the current thread.</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯commitåˆ™è¿›å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (isFromSyncCommit) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">wasEmpty</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">// ç”±äºcommitToMemoryä¼šè®©mDiskWritesInFlight+1ï¼Œåˆ™wasEmptyä¸ºtrue</span></span><br><span class="line">            wasEmpty = mDiskWritesInFlight == <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (wasEmpty) &#123;</span><br><span class="line">            <span class="comment">// åœ¨æ‰§è¡Œä¸€éä¸Šé¢çš„æ“ä½œï¼Œä¿è¯å°†commitçš„å†…å®¹ä¹Ÿä¿å­˜</span></span><br><span class="line">            writeToDiskRunnable.run();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯apply()æ–¹æ³•ï¼Œåˆ™ä¼šå°†ä»»åŠ¡æ”¾å…¥å•çº¿ç¨‹çš„çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œ</span></span><br><span class="line">    QueuedWork.queue(writeToDiskRunnable, !isFromSyncCommit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥ä»è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š</p>
<ul>
<li><code>commit()</code>æ˜¯ç›´æ¥åŒæ­¥æ‰§è¡Œçš„ï¼Œæœ‰æ•°æ®å°±å­˜å…¥ç£ç›˜</li>
<li><code>apply()</code>æ˜¯å…ˆå°†<code>awaitCommit</code>æ”¾å…¥<code>QueuedWork</code>ï¼Œç„¶ååœ¨å•çº¿ç¨‹çš„çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæ¯•åå†å°†<code>awaitCommit</code>ä»<code>QeueudWork</code>ä¸­ç§»é™¤ã€‚</li>
</ul>
<h1 id="3-çŸ¥è¯†ç‚¹"><a href="#3-çŸ¥è¯†ç‚¹" class="headerlink" title="3. çŸ¥è¯†ç‚¹"></a>3. çŸ¥è¯†ç‚¹</h1><h2 id="3-1-applyå’Œcommitçš„åŒºåˆ«"><a href="#3-1-applyå’Œcommitçš„åŒºåˆ«" class="headerlink" title="3.1 applyå’Œcommitçš„åŒºåˆ«"></a>3.1 applyå’Œcommitçš„åŒºåˆ«</h2><ul>
<li>applyæ²¡æœ‰è¿”å›å€¼, commitæœ‰è¿”å›å€¼èƒ½çŸ¥é“ä¿®æ”¹æ˜¯å¦æäº¤æˆåŠŸ</li>
<li>applyæ˜¯å°†ä¿®æ”¹æäº¤åˆ°å†…å­˜ï¼Œå†å¼‚æ­¥æäº¤åˆ°ç£ç›˜æ–‡ä»¶; commitæ˜¯åŒæ­¥çš„æäº¤åˆ°ç£ç›˜æ–‡ä»¶;</li>
<li>å¤šå¹¶å‘çš„æäº¤commitæ—¶ï¼Œéœ€ç­‰å¾…æ­£åœ¨å¤„ç†çš„commitæ•°æ®æ›´æ–°åˆ°ç£ç›˜æ–‡ä»¶åæ‰ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œä»è€Œé™ä½æ•ˆç‡; è€Œapplyåªæ˜¯åŸå­æ›´æ–°åˆ°å†…å­˜ï¼Œåè°ƒç”¨applyå‡½æ•°ä¼šç›´æ¥è¦†ç›–å‰é¢å†…å­˜æ•°æ®ï¼Œä»ä¸€å®šç¨‹åº¦ä¸Šæé«˜å¾ˆå¤šæ•ˆç‡ã€‚</li>
</ul>
<h2 id="3-2-å¤šè¿›ç¨‹çš„é—®é¢˜"><a href="#3-2-å¤šè¿›ç¨‹çš„é—®é¢˜" class="headerlink" title="3.2 å¤šè¿›ç¨‹çš„é—®é¢˜"></a>3.2 å¤šè¿›ç¨‹çš„é—®é¢˜</h2><p>æˆ‘ä»¬å‰é¢è¯´åˆ°äº†ï¼ŒSPæä¾›äº†å¤šè¿›ç¨‹è®¿é—®ï¼Œè™½è¯´æ²¡æœ‰åƒWorldæ¨¡å¼é‚£æ ·ä¼šç›´æ¥æŠ›å¼‚å¸¸ï¼Œä½†æ˜¯å®˜æ–¹ä¸å»ºè®®å¤šè¿›ç¨‹ä¸‹ä½¿ç”¨SPã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬ä¸ç¦ä¼šå¥½å¥‡ï¼Œå¤šè¿›ç¨‹ä¸‹è®¿é—®SPä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p>
<p>æ¢ç©¶è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¾—å…ˆå›åˆ°<code>ContextImpl#getSharedPreferences(File file, int mode)</code>æ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SharedPreferences <span class="title function_">getSharedPreferences</span><span class="params">(File file, <span class="type">int</span> mode)</span> &#123;</span><br><span class="line">    <span class="comment">// ...å‰é¢çš„ä»£ç çœç•¥çš„ï¼Œå¦‚æœå¤§å®¶æƒ³å›å¿†ä¸‹ï¼Œå¯ä»¥è·³è½¬åˆ°2.1èŠ‚</span></span><br><span class="line">    <span class="keyword">if</span> ((mode &amp; Context.MODE_MULTI_PROCESS) != <span class="number">0</span> ||</span><br><span class="line">        getApplicationInfo().targetSdkVersion &lt; android.os.Build.VERSION_CODES.HONEYCOMB) &#123;</span><br><span class="line">        <span class="comment">// If somebody else (some other process) changed the prefs</span></span><br><span class="line">        <span class="comment">// file behind our back, we reload it.  This has been the</span></span><br><span class="line">        <span class="comment">// historical (if undocumented) behavior.</span></span><br><span class="line">        <span class="comment">// -&gt;&gt;&gt; é‡ç‚¹1</span></span><br><span class="line">        sp.startReloadIfChangedUnexpectedly();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é‡ç‚¹1 SharedPreferencesImpl # startReloadIfChangedUnexpectedly()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">startReloadIfChangedUnexpectedly</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> wait for any pending writes to disk?</span></span><br><span class="line">        <span class="comment">// -&gt;&gt;&gt; é‡ç‚¹2</span></span><br><span class="line">        <span class="keyword">if</span> (!hasFileChangedUnexpectedly()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// -&gt;&gt;&gt; é‡ç‚¹3</span></span><br><span class="line">        startLoadFromDisk();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é‡ç‚¹2 SharedPreferencesImpl # hasFileChangedUnexpectedly()</span></span><br><span class="line"><span class="comment"> *  å¦‚æœæ–‡ä»¶å‘ç”Ÿäº†é¢„æœŸä¹‹å¤–çš„ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰å…¶ä»–è¿›ç¨‹åœ¨ä¿®æ”¹ï¼Œå°±è¿”å›trueï¼Œå¦åˆ™false</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasFileChangedUnexpectedly</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœmDiskWritesInFlightå¤§äº0ï¼Œå°±è¯æ˜æ˜¯åœ¨å½“å‰è¿›ç¨‹ä¸­ä¿®æ”¹çš„ï¼Œé‚£å°±ä¸ç”¨é‡æ–°è¯»å–</span></span><br><span class="line">        <span class="keyword">if</span> (mDiskWritesInFlight &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// If we know we caused it, it&#x27;s not unexpected.</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">&quot;disk write in flight, not unexpected.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> StructStat stat;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Metadata operations don&#x27;t usually count as a block guard</span></span><br><span class="line"><span class="comment">         * violation, but we explicitly want this one.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        BlockGuard.getThreadPolicy().onReadFromDisk();</span><br><span class="line">        stat = Os.stat(mFile.getPath());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ErrnoException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">return</span> !stat.st_mtim.equals(mStatTimestamp) || mStatSize != stat.st_size;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é‡ç‚¹3 SharedPreferencesImpl # startLoadFromDisk()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startLoadFromDisk</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        mLoaded = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;SharedPreferencesImpl-load&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// -&gt;&gt;&gt; é‡ç‚¹4ï¼Œè¿™å—ä»£ç å¯ä»¥å›åˆ°2.2.3çœ‹ä¸€ä¸‹</span></span><br><span class="line">            loadFromDisk();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼šæ¯æ¬¡è·å–SharedPreferenceså®ä¾‹çš„æ—¶å€™å°è¯•ä»ç£ç›˜ä¸­åŠ è½½æ•°æ®ï¼Œå¹¶ä¸”æ˜¯åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­ï¼Œå› æ­¤ä¸€ä¸ªçº¿ç¨‹çš„ä¿®æ”¹æœ€ç»ˆä¼šåæ˜ åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†ä¸èƒ½ç«‹å³åæ˜ åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥é€šè¿‡SharedPreferencesæ— æ³•å®ç°å¤šè¿›ç¨‹åŒæ­¥ã€‚</p>
<p><code>loadFromDisk()</code>æ–¹æ³•ä¸­æˆ‘ä»¬æœ€éœ€è¦å…³æ³¨çš„æ˜¯è¿™ä¸€æ®µï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœå¤‡ä»½æ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œé‚£å°±åˆ é™¤æºæ–‡ä»¶ï¼Œå¹¶å°†å¤‡ä»½æ–‡ä»¶æ›¿æ¢ä¸ºæºæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">if</span> (mBackupFile.exists()) &#123;</span><br><span class="line">    mFile.delete();</span><br><span class="line">    mBackupFile.renameTo(mFile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™å—åˆ¤æ–­äº†<code>mBackupFile</code>æ˜¯å¦å­˜åœ¨ï¼Œé‚£<code>mBackupFile</code>æˆ‘ä»¬æ˜¯åœ¨å“ªåˆ›å»ºçš„å‘¢ï¼Ÿ<br>æ•´ä¸ªSharedPreferencesImplä¸­æœ‰ä¸¤å¤„ï¼š</p>
<ul>
<li>æ„é€ æ–¹æ³•ï¼šä¼šè°ƒç”¨<code>makeBackupFile()</code>ç»™ä¼ å…¥çš„<code>file</code>æ„é€ ä¸€ä¸ª<code>mBackupFile</code></li>
<li>writeToFile()ï¼šåœ¨å†™å…¥åˆ°ç£ç›˜çš„æ–‡ä»¶æ—¶ï¼Œå¦‚æœæ²¡æœ‰<code>mBackupFile</code>ï¼Œå°±ä¼šæ ¹æ®å½“å‰çš„<code>mFile</code>é‡å‘½åä¸º<code>mBackupFile</code></li>
</ul>
<p>è€Œ<code>writeToFile()</code>åœ¨<code>enqueueDiskWrite()</code>ä¸­è¢«è°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•å¤ªé•¿äº†ï¼Œæˆ‘æˆªå–ä¸‹å…³é”®ä¿¡æ¯ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GuardedBy(&quot;mWritingToDiskLock&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeToFile</span><span class="params">(MemoryCommitResult mcr, <span class="type">boolean</span> isFromSyncCommit)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">fileExists</span> <span class="operator">=</span> mFile.exists();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Rename the current file so it may be used as a backup during the next read</span></span><br><span class="line">    <span class="keyword">if</span> (fileExists) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">backupFileExists</span> <span class="operator">=</span> mBackupFile.exists();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">if</span> (!backupFileExists) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mFile.renameTo(mBackupFile)) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;Couldn&#x27;t rename file &quot;</span> + mFile</span><br><span class="line">                      + <span class="string">&quot; to backup file &quot;</span> + mBackupFile);</span><br><span class="line">                mcr.setDiskWriteResult(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mFile.delete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Attempt to write the file, delete the backup and return true as atomically as</span></span><br><span class="line">    <span class="comment">// possible.  If any exception occurs, delete the new file; next time we will restore</span></span><br><span class="line">    <span class="comment">// from the backup.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">str</span> <span class="operator">=</span> createFileOutputStream(mFile);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        XmlUtils.writeMapXml(mcr.mapToWriteToDisk, str);</span><br><span class="line"></span><br><span class="line">        writeTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        FileUtils.sync(str);</span><br><span class="line"></span><br><span class="line">        fsyncTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        str.close();</span><br><span class="line">        ContextImpl.setFilePermissionsFromMode(mFile.getPath(), mMode, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">StructStat</span> <span class="variable">stat</span> <span class="operator">=</span> Os.stat(mFile.getPath());</span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                mStatTimestamp = stat.st_mtim;</span><br><span class="line">                mStatSize = stat.st_size;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ErrnoException e) &#123;</span><br><span class="line">            <span class="comment">// Do nothing</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            fstatTime = System.currentTimeMillis();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Writing was successful, delete the backup file if there is one.</span></span><br><span class="line">        mBackupFile.delete();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><br>æ‰€ä»¥æˆ‘ä»¬å¤§è‡´æ€»ç»“ä¸‹è¿™ä¸ªæ–¹æ³•çš„åŠŸèƒ½ï¼š</p>
<ul>
<li>å¦‚æœæºæ–‡ä»¶<code>mFIle</code>å­˜åœ¨å¹¶ä¸”å¤‡ä»½æ–‡ä»¶<code>mBackupFile</code>ä¸å­˜åœ¨ï¼Œå°±å°†æºæ–‡ä»¶é‡å‘½åä¸ºå¤‡ä»½æ–‡ä»¶ï¼Œå¦‚æœæºæ–‡ä»¶å­˜åœ¨å¹¶ä¸”å¤‡ä»½æ–‡ä»¶å­˜åœ¨ï¼Œå°±åˆ é™¤æºæ–‡ä»¶</li>
<li>é‡æ–°åˆ›å»ºæºæ–‡ä»¶<code>mFile</code>ï¼Œå¹¶å°†å†…å®¹å†™è¿›å»</li>
<li>åˆ é™¤<code>mBackupFile</code></li>
</ul>
<p>ç»“åˆä¸€ä¸‹<code>loadFromDisk()</code>å’Œ<code>writeToFile()</code>ä¸¤ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æ¨æµ‹å‡ºï¼šå½“å­˜åœ¨ä¸¤ä¸ªè¿›ç¨‹ï¼Œä¸€ä¸ªè¯»è¿›ç¨‹ï¼Œä¸€ä¸ªå†™è¿›ç¨‹ï¼Œç”±äºåªæœ‰åœ¨åˆ›å»º<code>SharedPreferencesImpl</code>çš„æ—¶å€™åˆ›å»ºäº†ä¸€ä¸ªå¤‡ä»½è¿›ç¨‹ï¼Œæ­¤æ—¶è¯»è¿›ç¨‹ä¼šå°†æºæ–‡ä»¶åˆ é™¤ï¼Œå¹¶å°†å¤‡ä»½æ–‡ä»¶é‡å‘½åä¸ºæºæ–‡ä»¶ï¼Œè¿™æ ·çš„ç»“æœå°±æ˜¯ï¼Œè¯»è¿›ç¨‹æ°¸è¿œåªä¼šçœ‹åˆ°å†™ä¹‹å‰çš„å†…å®¹ã€‚å¹¶ä¸”ç”±äºå†™æ–‡ä»¶éœ€è¦è°ƒç”¨<code>createFileOutputStream(mFile)</code>ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ç”±äºæºæ–‡ä»¶è¢«è¯»è¿›ç¨‹åˆ é™¤äº†ï¼Œæ‰€ä»¥å¯¼è‡´å†™è¿›ç¨‹çš„<code>mFIle</code>æ²¡æœ‰äº†å¼•ç”¨ï¼Œä¹Ÿå°±ä¼šåˆ›å»ºå¤±è´¥ï¼Œå¯¼è‡´ä¿®æ”¹çš„æ•°æ®æ— æ³•æ›´æ–°åˆ°æ–‡ä»¶ä¸Šï¼Œè¿›è€Œå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚</p>
<h2 id="3-3-å»ºè®®ä¼˜åŒ–"><a href="#3-3-å»ºè®®ä¼˜åŒ–" class="headerlink" title="3.3 å»ºè®®ä¼˜åŒ–"></a>3.3 å»ºè®®ä¼˜åŒ–</h2><ul>
<li>ä¸è¦åœ¨SPä¸­å­˜å‚¨è¾ƒå¤§çš„keyæˆ–è€…value</li>
<li>åªæ˜¯ç”¨MODE_PRIVATEæ¨¡å¼ï¼Œå…¶å®ƒæ¨¡å¼éƒ½ä¸è¦ä½¿ç”¨(ä¹Ÿè¢«å¼ƒç”¨äº†)</li>
<li>å¯ä»¥çš„è¯ï¼Œå°½é‡è·å–ä¸€æ¬¡Editorç„¶åæäº¤æ‰€æœ‰çš„æ•°æ®</li>
<li>ä¸è¦é«˜é¢‘ä½¿ç”¨applyï¼Œå› ä¸ºä»–æ¯æ¬¡éƒ½ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼›ä½¿ç”¨commitçš„æ—¶éœ€è°¨æ…ï¼Œå› ä¸ºä»–åœ¨ä¸»çº¿ç¨‹ä¸­æ“ä½œ(å¯¹ï¼Œå°±æ˜¯ä¸»çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹å¹¶ä¸æ˜¯åªèƒ½æ›´æ–°UIï¼Œä½†æ˜¯è¿˜æ˜¯å°±æŠŠä¸»çº¿ç¨‹å½“åšæ›´æ–°UIçš„ä¸ºå¥½ï¼Œæˆ‘ä»¬çš„è€—æ—¶æ“ä½œæœ€å¥½ä¸è¦åœ¨ä¸»çº¿ç¨‹ä¸­)</li>
<li>å¦‚æœéœ€è¦åœ¨å¤šè¿›ç¨‹ä¸­å­˜å‚¨æ•°æ®ï¼Œå»ºè®®ä½¿ç”¨ContentProvider</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://www.littlecorgi.top">littlecorgi</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://www.littlecorgi.top/posts/24e17cf4.html">https://www.littlecorgi.top/posts/24e17cf4.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://www.littlecorgi.top" target="_blank">å°æŸ¯åŸº</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81/">æºç </a><a class="post-meta__tags" href="/tags/SharedPreferences/">SharedPreferences</a><a class="post-meta__tags" href="/tags/%E5%AD%98%E5%82%A8/">å­˜å‚¨</a></div><div class="post_share"><div class="social-share" data-image="https://dignitas.digital/wp-content/uploads/2019/02/SharedAndroid2-e1550504097495.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> æ‰“èµ</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li><li class="reward-item"><a href="/" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/53c3ccc1.html"><img class="prev-cover" src="https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">Jetpackæºç  ä¹‹ Lifecycle</div></div></a></div><div class="next-post pull-right"><a href="/posts/b1488352.html"><img class="next-cover" src="https://cdn.littlecorgi.top/Android%20Jetpack%E5%A4%B4%E5%9B%BE.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">Jetpackå…¥é—¨ ä¹‹ LiveDataçš„map()å’ŒswitchMap</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/21eb5c30.html" title="Androidæ¶ˆæ¯æœºåˆ¶ä¹‹Handlerè¯¦è§£"><img class="cover" src="https://cdn.littlecorgi.top/blog/Keynote_Blog_FINAL.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-11-17</div><div class="title">Androidæ¶ˆæ¯æœºåˆ¶ä¹‹Handlerè¯¦è§£</div></div></a></div><div><a href="/posts/64f0a9f6.html" title="Androidæ¶ˆæ¯æœºåˆ¶ä¹‹ThreadLocal"><img class="cover" src="https://cdn.littlecorgi.top/blog/Keynote_Blog_FINAL.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-11-08</div><div class="title">Androidæ¶ˆæ¯æœºåˆ¶ä¹‹ThreadLocal</div></div></a></div><div><a href="/posts/eb898689.html" title="Androidç½‘ç»œè¯·æ±‚1--HttpClientä¸HttpURLConnection"><img class="cover" src="https://i.loli.net/2019/11/10/T7Mu8Aod3egmC4Q.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-08-06</div><div class="title">Androidç½‘ç»œè¯·æ±‚1--HttpClientä¸HttpURLConnection</div></div></a></div><div><a href="/posts/df8fd75e.html" title="Androidç½‘ç»œè¯·æ±‚2--è§£æVolleyæºç "><img class="cover" src="https://i.loli.net/2019/11/10/xthHmnbdNerWOqP.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-07-25</div><div class="title">Androidç½‘ç»œè¯·æ±‚2--è§£æVolleyæºç </div></div></a></div><div><a href="/posts/151ac78a.html" title="Androidç½‘ç»œè¯·æ±‚3--è§£æOkHttpæºç "><img class="cover" src="https://i.loli.net/2019/11/10/xthHmnbdNerWOqP.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-07-26</div><div class="title">Androidç½‘ç»œè¯·æ±‚3--è§£æOkHttpæºç </div></div></a></div><div><a href="/posts/a2a8de56.html" title="Androidç½‘ç»œè¯·æ±‚4--è§£æRetrofitæºç "><img class="cover" src="https://i.loli.net/2019/11/10/T7Mu8Aod3egmC4Q.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-08-06</div><div class="title">Androidç½‘ç»œè¯·æ±‚4--è§£æRetrofitæºç </div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/uploads/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">littlecorgi</div><div class="author-info__description">å…´è¶£ä½¿ç„¶çš„ä¸ªäººå°ç«™ï¼Œä¸å®šæ—¶åˆ†äº«Androidç­‰æŠ€æœ¯åšå®¢</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">65</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">43</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/littlecorgi-twk" target="_blank" title=""><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:littlecorgi.twk@gmail.com" target="_blank" title=""><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title=""><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">ç›®å‰å‡†å¤‡é¢è¯•ä¸­ï¼Œé¢è¯•å®Œäº†å†æ›´æ–°åšå®¢ã€‚</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SharedPreferences%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">SharedPreferencesæºç åˆ†æ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0-%E5%89%8D%E8%A8%80"><span class="toc-text">0. å‰è¨€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-text">1. ä½¿ç”¨æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E8%8E%B7%E5%8F%96SharedPreferences"><span class="toc-text">1.1 è·å–SharedPreferences</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-Context-getSharedPreferences"><span class="toc-text">1.1.1 Context # getSharedPreferences()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2-Activity-getPreferences"><span class="toc-text">1.1.2 Activity # getPreferences()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-3-PreferencesManager-getDefaultSharedPreferences"><span class="toc-text">1.1.3 PreferencesManager # getDefaultSharedPreferences()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E5%AD%98%E6%95%B0%E6%8D%AE"><span class="toc-text">1.2 å­˜æ•°æ®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="toc-text">1.3 å–æ•°æ®</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">2. æºç åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E8%8E%B7%E5%8F%96SharedPreferences%E5%AE%9E%E4%BE%8B"><span class="toc-text">2.1 è·å–SharedPreferenceså®ä¾‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E6%9E%84%E5%BB%BASharedPreferencesImpl"><span class="toc-text">2.2 æ„å»ºSharedPreferencesImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-SharedPreferencesImpl%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-text">2.2.1 SharedPreferencesImplæ„é€ æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-startLoadFromDisk"><span class="toc-text">2.2.2 startLoadFromDisk()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-loadFromDIsk"><span class="toc-text">2.2.3 loadFromDIsk()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E8%AF%BB%E6%95%B0%E6%8D%AE-SharedPreferences-getXXX"><span class="toc-text">2.3 è¯»æ•°æ® SharedPreferences # getXXX()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-getString"><span class="toc-text">2.3.1 getString</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-awaitLoadedLocked"><span class="toc-text">2.3.2 awaitLoadedLocked</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E5%86%99%E6%95%B0%E6%8D%AE"><span class="toc-text">2.4 å†™æ•°æ®</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-SharedPreferences-Editor"><span class="toc-text">2.4.1 SharedPreferences.Editor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-2-EditorImpl"><span class="toc-text">2.4.2 EditorImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-1-putXXX"><span class="toc-text">2.4.2.1 putXXX()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-2-apply"><span class="toc-text">2.4.2.2 apply()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-3-commit"><span class="toc-text">2.4.2.3 commit()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-4-commitToMemory"><span class="toc-text">2.4.2.4 commitToMemory()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-5-SharedPreferencesImpl-enqueueDiskWrite"><span class="toc-text">2.4.2.5 SharedPreferencesImpl # enqueueDiskWrite()</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-text">3. çŸ¥è¯†ç‚¹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-apply%E5%92%8Ccommit%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">3.1 applyå’Œcommitçš„åŒºåˆ«</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">3.2 å¤šè¿›ç¨‹çš„é—®é¢˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E5%BB%BA%E8%AE%AE%E4%BC%98%E5%8C%96"><span class="toc-text">3.3 å»ºè®®ä¼˜åŒ–</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/79199b37.html" title="æ·±å…¥ç†è§£JVM-Referenceæºç "><img src="https://raw.githubusercontent.com/zxh0/jvmgo-book/master/v1/gophers/cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="æ·±å…¥ç†è§£JVM-Referenceæºç "/></a><div class="content"><a class="title" href="/posts/79199b37.html" title="æ·±å…¥ç†è§£JVM-Referenceæºç ">æ·±å…¥ç†è§£JVM-Referenceæºç </a><time datetime="2021-03-21T14:15:24.000Z" title="æ›´æ–°äº 2021-03-21 22:15:24">2021-03-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f5a785d7.html" title="Koin-12-Koin for Android"><img src="https://pbs.twimg.com/profile_banners/936214891731603456/1523947778/1500x500" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Koin-12-Koin for Android"/></a><div class="content"><a class="title" href="/posts/f5a785d7.html" title="Koin-12-Koin for Android">Koin-12-Koin for Android</a><time datetime="2020-10-07T13:25:34.000Z" title="æ›´æ–°äº 2020-10-07 21:25:34">2020-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/ebed2a69.html" title="Koin-11-Koin for Java"><img src="https://pbs.twimg.com/profile_banners/936214891731603456/1523947778/1500x500" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Koin-11-Koin for Java"/></a><div class="content"><a class="title" href="/posts/ebed2a69.html" title="Koin-11-Koin for Java">Koin-11-Koin for Java</a><time datetime="2020-10-07T13:25:27.000Z" title="æ›´æ–°äº 2020-10-07 21:25:27">2020-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/63fa5724.html" title="Koin-10-Testing(æµ‹è¯•)"><img src="https://pbs.twimg.com/profile_banners/936214891731603456/1523947778/1500x500" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Koin-10-Testing(æµ‹è¯•)"/></a><div class="content"><a class="title" href="/posts/63fa5724.html" title="Koin-10-Testing(æµ‹è¯•)">Koin-10-Testing(æµ‹è¯•)</a><time datetime="2020-10-07T13:25:15.000Z" title="æ›´æ–°äº 2020-10-07 21:25:15">2020-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f85e8eae.html" title="Koin-9-Koin Components(ç»„ä»¶)"><img src="https://pbs.twimg.com/profile_banners/936214891731603456/1523947778/1500x500" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Koin-9-Koin Components(ç»„ä»¶)"/></a><div class="content"><a class="title" href="/posts/f85e8eae.html" title="Koin-9-Koin Components(ç»„ä»¶)">Koin-9-Koin Components(ç»„ä»¶)</a><time datetime="2020-10-07T13:25:00.000Z" title="æ›´æ–°äº 2020-10-07 21:25:00">2020-10-07</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://dignitas.digital/wp-content/uploads/2019/02/SharedAndroid2-e1550504097495.png')"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2023 By littlecorgi</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="https://beian.miit.gov.cn/" target="_blank">ç²¤ICPå¤‡2022036896å·-1</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>